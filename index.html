<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Económico Sudamérica</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f6fa;
    --surface: #ffffff;
    --border: #dde1ee;
    --accent: #1a56db;
    --text: #1a1f36;
    --muted: #6b7394;
    --arg: #2563eb;
    --bra: #16a34a;
    --chl: #dc2626;
    --ury: #d97706;
    --pry: #7c3aed;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background texture */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse 80% 50% at 20% 10%, rgba(37,99,235,0.05) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 80%, rgba(124,58,237,0.04) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 24px;
    position: relative;
    z-index: 1;
  }

  header {
    margin-bottom: 48px;
  }

  .header-top {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 16px;
  }

  .title-block h1 {
    font-family: 'DM Serif Display', serif;
    font-size: clamp(2rem, 4vw, 3rem);
    line-height: 1.1;
    letter-spacing: -0.02em;
    color: var(--text);
  }

  .title-block h1 em {
    color: var(--accent);
    font-style: italic;
  }

  .subtitle {
    font-size: 0.75rem;
    color: var(--muted);
    margin-top: 8px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .data-sources {
    font-size: 0.65rem;
    color: var(--muted);
    text-align: right;
    line-height: 1.7;
  }

  .data-sources span {
    display: block;
  }

  /* Legend */
  .legend {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 40px;
    padding: 16px 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 3px;
    transition: background 0.2s;
    user-select: none;
  }

  .legend-item:hover {
    background: rgba(0,0,0,0.05);
  }

  .legend-item.inactive {
    opacity: 0.35;
  }

  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .legend-label {
    font-size: 0.8rem;
    font-weight: 500;
    letter-spacing: 0.05em;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 8px;
  }

  .tab-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 8px 20px;
    cursor: pointer;
    border-radius: 3px;
    transition: all 0.2s;
  }

  .tab-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: #0b0f1a;
    font-weight: 500;
  }

  .tab-btn:hover:not(.active) {
    border-color: var(--accent);
    color: var(--accent);
  }

  /* Chart panels */
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 28px;
    margin-bottom: 24px;
    display: none;
  }

  .panel.active { display: block; }

  .panel-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.25rem;
    margin-bottom: 6px;
  }

  .panel-desc {
    font-size: 0.7rem;
    color: var(--muted);
    margin-bottom: 24px;
    letter-spacing: 0.04em;
  }

  .chart-wrap {
    position: relative;
    height: 400px;
  }

  /* Stats row */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-top: 24px;
  }

  @media (max-width: 700px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
  }

  .stat-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 14px;
    border-top: 2px solid;
  }

  .stat-label {
    font-size: 0.62rem;
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  .stat-value {
    font-size: 1.1rem;
    font-weight: 500;
    margin-bottom: 2px;
  }

  .stat-change {
    font-size: 0.65rem;
    color: var(--muted);
  }

  .pos { color: #16a34a; }
  .neg { color: #dc2626; }

  /* Divider */
  .divider {
    height: 1px;
    background: var(--border);
    margin: 32px 0;
  }

  /* Range slider */
  .range-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .range-row label {
    font-size: 0.72rem;
    color: var(--muted);
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  .range-row input[type=range] {
    accent-color: var(--accent);
    cursor: pointer;
  }

  .range-val {
    font-size: 0.75rem;
    color: var(--accent);
    min-width: 80px;
  }

  /* Scatter panel */
  .scatter-info {
    font-size: 0.7rem;
    color: var(--muted);
    margin-top: 12px;
    text-align: center;
  }

  footer {
    margin-top: 48px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.05em;
    line-height: 1.8;
  }
</style>
</head>
<body>
<div class="container">

  <header>
    <div class="header-top">
      <div class="title-block">
        <h1>Economías del <em>Cono Sur</em></h1>
        <p class="subtitle">Dashboard comparativo · Argentina · Brasil · Chile · Uruguay · Paraguay</p>
      </div>
      <div class="data-sources">
        <span>Fuente PBI per cápita: World Bank WDI — NY.GDP.PCAP.PP.KD</span>
        <span>Fuente Gasto Público: IMF Fiscal Monitor — exp@FPP</span>
        <span>Fuente Inversión: World Bank WDI — NE.GDI.FTOT.ZS</span>
        <span>Dólares internacionales constantes 2021 (PPP)</span>
      </div>
    </div>
  </header>

  <!-- Legend -->
  <div class="legend" id="legend">
    <div class="legend-item" data-country="ARG" onclick="toggleCountry('ARG', this)">
      <div class="legend-dot" style="background:var(--arg)"></div>
      <span class="legend-label">Argentina</span>
    </div>
    <div class="legend-item" data-country="BRA" onclick="toggleCountry('BRA', this)">
      <div class="legend-dot" style="background:var(--bra)"></div>
      <span class="legend-label">Brasil</span>
    </div>
    <div class="legend-item" data-country="CHL" onclick="toggleCountry('CHL', this)">
      <div class="legend-dot" style="background:var(--chl)"></div>
      <span class="legend-label">Chile</span>
    </div>
    <div class="legend-item" data-country="URY" onclick="toggleCountry('URY', this)">
      <div class="legend-dot" style="background:var(--ury)"></div>
      <span class="legend-label">Uruguay</span>
    </div>
    <div class="legend-item" data-country="PRY" onclick="toggleCountry('PRY', this)">
      <div class="legend-dot" style="background:var(--pry)"></div>
      <span class="legend-label">Paraguay</span>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('gdp', this)">PBI per Cápita PPP</button>
    <button class="tab-btn" onclick="switchTab('exp', this)">Gasto Público / PBI</button>
    <button class="tab-btn" onclick="switchTab('inv', this)">Inversión / PBI</button>
    <button class="tab-btn" onclick="switchTab('scatter', this)">Dispersión</button>
  </div>

  <!-- GDP Panel -->
  <div class="panel active" id="panel-gdp">
    <div class="panel-title">PBI per Cápita (PPP)</div>
    <p class="panel-desc">USD constantes 2021 (paridad de poder adquisitivo) · 1990–2023</p>
    <div class="range-row">
      <label>Desde</label>
      <input type="range" id="gdp-from" min="1990" max="2022" value="1990" step="1" oninput="updateGdpRange()">
      <span class="range-val" id="gdp-from-val">1990</span>
      <label>Hasta</label>
      <input type="range" id="gdp-to" min="1991" max="2023" value="2023" step="1" oninput="updateGdpRange()">
      <span class="range-val" id="gdp-to-val">2023</span>
    </div>
    <div class="chart-wrap">
      <canvas id="gdpChart"></canvas>
    </div>
    <div class="stats-grid" id="gdp-stats"></div>
  </div>

  <!-- Expenditure Panel -->
  <div class="panel" id="panel-exp">
    <div class="panel-title">Gasto Público Total (% del PBI)</div>
    <p class="panel-desc">Gobierno general · gasto total como porcentaje del PBI · 1995–2029 (proyección IMF tras 2023)</p>
    <div class="range-row">
      <label>Desde</label>
      <input type="range" id="exp-from" min="1995" max="2027" value="1995" step="1" oninput="updateExpRange()">
      <span class="range-val" id="exp-from-val">1995</span>
      <label>Hasta</label>
      <input type="range" id="exp-to" min="1996" max="2029" value="2029" step="1" oninput="updateExpRange()">
      <span class="range-val" id="exp-to-val">2029</span>
    </div>
    <div class="chart-wrap">
      <canvas id="expChart"></canvas>
    </div>
    <div class="stats-grid" id="exp-stats"></div>
  </div>

  <!-- Investment Panel -->
  <div class="panel" id="panel-inv">
    <div class="panel-title">Formación Bruta de Capital Fijo (% del PBI)</div>
    <p class="panel-desc">Inversión total como porcentaje del PBI · 1990–2023 · Fuente: World Bank NE.GDI.FTOT.ZS</p>
    <div class="range-row">
      <label>Desde</label>
      <input type="range" id="inv-from" min="1990" max="2022" value="1990" step="1" oninput="updateInvRange()">
      <span class="range-val" id="inv-from-val">1990</span>
      <label>Hasta</label>
      <input type="range" id="inv-to" min="1991" max="2023" value="2023" step="1" oninput="updateInvRange()">
      <span class="range-val" id="inv-to-val">2023</span>
    </div>
    <div class="chart-wrap">
      <canvas id="invChart"></canvas>
    </div>
    <div class="stats-grid" id="inv-stats"></div>
  </div>

  <!-- Scatter Panel -->
  <div class="panel" id="panel-scatter">
    <div class="panel-title">Gasto Público vs. PBI per Cápita</div>
    <p class="panel-desc">Relación entre tamaño del Estado y nivel de ingreso por habitante · cada punto = un año</p>
    <div class="range-row">
      <label>Año</label>
      <input type="range" id="scatter-year" min="1995" max="2023" value="2023" step="1" oninput="updateScatter()">
      <span class="range-val" id="scatter-year-val">2023</span>
      <label style="margin-left:12px; color:var(--text)">— o animación:</label>
      <button onclick="toggleAnimation()" id="anim-btn" style="background:var(--accent);border:none;color:#ffffff;font-family:'DM Mono',monospace;font-size:0.7rem;padding:6px 14px;cursor:pointer;border-radius:3px;font-weight:500">▶ PLAY</button>
    </div>
    <div class="chart-wrap">
      <canvas id="scatterChart"></canvas>
    </div>
    <p class="scatter-info">Tamaño del punto proporcional al PBI per cápita relativo. Hover para ver datos.</p>
  </div>

  <footer>
    Nota metodológica: Los datos de PBI per cápita PPP provienen de World Development Indicators (World Bank), en dólares internacionales constantes de 2021.
    El gasto público corresponde al indicador "General Government Total Expenditure" del IMF Fiscal Monitor (% del PBI).
    La inversión corresponde a "Gross Fixed Capital Formation" (NE.GDI.FTOT.ZS) del World Bank WDI (% del PBI).
    Valores posteriores a 2023 en gasto público son proyecciones del FMI. Los datos fueron incorporados manualmente a partir de las series oficiales publicadas por ambos organismos.
  </footer>

</div>

<script>
// ─── DATA ───────────────────────────────────────────────────────────────
// GDP per capita PPP (constant 2021 international $) — World Bank NY.GDP.PCAP.PP.KD
const gdpData = {
  years: [1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023],
  ARG: [9271,9540,10290,11064,11777,11390,12063,13003,13221,12047,11752,10954,9393,10051,11022,11736,12676,13702,14282,13607,14660,15661,15466,16031,15777,15395,14773,15483,14809,14226,12898,14630,15422,15104],
  BRA: [9189,8921,9201,9649,10135,10290,10575,11035,10898,10582,10762,10558,10616,11050,11777,12445,13063,13756,14337,14223,15388,16135,16423,16676,16558,16272,15629,15814,16148,16041,15005,16380,17249,17491],
  CHL: [8489,9202,9960,10791,11688,11967,12535,13371,13483,13380,13610,13565,13505,13918,14753,15602,16540,17432,17963,17412,18878,20050,20777,21448,21499,22005,21945,22774,23851,23811,21927,23611,25305,25859],
  URY: [9289,9458,9941,10533,11122,11386,12042,12607,12588,12078,11809,11064,9811,10396,11425,12568,13686,14788,15678,15913,17156,18386,19268,20208,20803,21168,21431,22151,22635,22607,20776,22622,24089,24667],
  PRY: [5234,5081,5194,5443,5532,5459,5529,5673,5571,5264,5370,5338,5051,5455,5782,6043,6392,6710,7017,6626,7455,7940,8034,8614,8681,8786,8775,9227,9641,9664,9124,10098,10796,10814],
};

// Government expenditure (% of GDP) — IMF Fiscal Monitor exp@FPP
const expData = {
  years: [1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023,2024,2025,2026,2027,2028,2029],
  ARG: [26.8,26.1,26.3,27.2,28.9,27.7,27.8,29.2,28.0,27.5,28.0,28.5,30.2,31.1,35.6,34.2,34.6,36.3,37.0,37.6,40.2,40.9,39.7,37.9,38.0,43.0,38.3,36.9,35.7,35.9,36.1,36.0,35.9,35.8,35.7],
  BRA: [35.1,35.9,36.8,38.1,40.0,40.7,41.0,41.4,42.0,42.3,42.8,42.8,43.0,43.7,45.6,45.4,44.7,45.3,45.8,45.7,45.6,46.3,46.7,45.7,44.5,49.1,46.3,46.2,46.3,46.5,46.5,46.5,46.4,46.3,46.2],
  CHL: [21.7,21.0,20.9,22.0,22.6,21.9,23.9,24.5,24.0,22.6,21.7,20.2,20.9,22.9,27.1,24.9,22.8,22.7,22.5,23.2,24.3,25.6,25.7,26.0,27.0,34.7,30.2,31.0,29.7,29.5,29.3,29.2,28.7,28.4,28.1],
  URY: [28.6,29.4,29.8,31.0,32.8,32.0,34.2,34.5,31.0,28.6,28.7,28.7,29.0,30.4,33.9,31.9,30.6,31.6,32.4,33.5,34.1,34.1,33.2,33.2,32.9,35.8,34.2,33.2,33.4,33.5,33.5,33.4,33.3,33.2,33.1],
  PRY: [16.2,16.7,17.4,19.2,19.4,18.3,20.4,19.7,17.8,16.6,15.5,16.2,17.0,18.5,20.3,19.4,19.7,22.3,23.1,22.1,21.5,20.8,20.6,20.5,21.1,24.3,23.1,22.8,23.0,22.9,23.0,23.0,22.9,22.8,22.7],
};

// Gross Fixed Capital Formation (% of GDP) — World Bank NE.GDI.FTOT.ZS
const invData = {
  years: [1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023],
  ARG: [14.2,14.6,16.7,18.4,19.8,17.8,18.5,19.9,19.3,15.7,15.9,14.4,11.6,14.4,17.6,19.8,21.2,22.2,22.1,18.0,20.3,21.9,22.0,21.0,19.9,18.3,16.3,18.0,17.4,16.0,14.5,18.7,19.6,17.4],
  BRA: [20.7,18.1,18.4,19.3,20.8,18.3,16.9,17.4,17.0,16.3,16.8,17.0,16.4,15.3,16.1,15.9,16.4,17.4,19.1,18.1,20.2,20.6,20.7,20.9,20.1,17.8,15.7,15.2,15.4,15.2,16.4,18.1,18.6,17.3],
  CHL: [23.0,19.0,21.8,23.6,24.8,23.2,23.6,24.1,22.8,18.4,20.3,21.9,20.1,19.3,19.6,21.3,19.6,21.4,24.0,22.2,22.4,22.4,23.7,23.9,22.5,22.7,22.0,21.8,23.0,22.0,22.5,24.9,25.9,24.2],
  URY: [13.3,12.1,14.3,14.4,14.4,13.0,14.1,15.4,15.8,13.7,13.3,13.3,10.6,12.5,16.0,18.0,18.0,18.2,20.1,18.4,20.1,19.9,21.3,22.9,22.3,20.2,18.6,18.7,18.2,17.7,17.1,19.0,18.5,17.2],
  PRY: [24.8,21.0,22.6,23.9,22.2,20.8,19.5,19.8,21.6,18.3,18.6,17.3,17.0,17.9,18.7,18.8,18.7,19.8,21.6,20.6,21.7,22.4,24.1,27.3,27.4,28.3,27.7,25.9,25.4,24.1,23.8,25.3,27.0,25.6],
};

// ─── COLORS ─────────────────────────────────────────────────────────────
const COLORS = {
  ARG: { line: '#2563eb', bg: 'rgba(37,99,235,0.08)', label: 'Argentina' },
  BRA: { line: '#16a34a', bg: 'rgba(22,163,74,0.08)', label: 'Brasil' },
  CHL: { line: '#dc2626', bg: 'rgba(220,38,38,0.08)', label: 'Chile' },
  URY: { line: '#d97706', bg: 'rgba(217,119,6,0.08)', label: 'Uruguay' },
  PRY: { line: '#7c3aed', bg: 'rgba(124,58,237,0.08)', label: 'Paraguay' },
};

const countries = ['ARG','BRA','CHL','URY','PRY'];
let activeCountries = new Set(countries);

// ─── CHART DEFAULTS ──────────────────────────────────────────────────────
const chartDefaults = {
  responsive: true,
  maintainAspectRatio: false,
  interaction: { mode: 'index', intersect: false },
  plugins: {
    legend: { display: false },
    tooltip: {
      backgroundColor: '#ffffff',
      borderColor: '#dde1ee',
      borderWidth: 1,
      titleColor: '#1a1f36', bodyColor: '#1a1f36', titleFont: { family: 'DM Mono', size: 11 },
      bodyFont: { family: 'DM Mono', size: 11 },
      padding: 12,
      callbacks: {}
    }
  },
  scales: {
    x: {
      grid: { color: 'rgba(0,0,0,0.06)' },
      ticks: { color: '#6b7394', font: { family: 'DM Mono', size: 10 } },
      border: { color: '#dde1ee' }
    },
    y: {
      grid: { color: 'rgba(0,0,0,0.06)' },
      ticks: { color: '#6b7394', font: { family: 'DM Mono', size: 10 } },
      border: { color: '#dde1ee' }
    }
  }
};

// ─── GDP CHART ───────────────────────────────────────────────────────────
let gdpChart, expChart, scatterChart;
let gdpFrom = 1990, gdpTo = 2023;
let expFrom = 1995, expTo = 2029;
let scatterYear = 2023;
let animInterval = null;

function makeGdpDatasets(from, to) {
  const idxFrom = gdpData.years.indexOf(from);
  const idxTo = gdpData.years.indexOf(to);
  const labels = gdpData.years.slice(idxFrom, idxTo+1);
  const datasets = countries.map(c => ({
    label: COLORS[c].label,
    data: gdpData[c].slice(idxFrom, idxTo+1),
    borderColor: COLORS[c].line,
    backgroundColor: COLORS[c].bg,
    borderWidth: 2,
    pointRadius: 0,
    pointHoverRadius: 5,
    tension: 0.35,
    fill: false,
    hidden: !activeCountries.has(c),
  }));
  return { labels, datasets };
}

function buildGdpChart() {
  const ctx = document.getElementById('gdpChart').getContext('2d');
  const { labels, datasets } = makeGdpDatasets(gdpFrom, gdpTo);
  gdpChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      ...JSON.parse(JSON.stringify(chartDefaults)),
      plugins: {
        ...JSON.parse(JSON.stringify(chartDefaults.plugins)),
        tooltip: {
          ...JSON.parse(JSON.stringify(chartDefaults.plugins.tooltip)),
          callbacks: {
            label: ctx => ` ${ctx.dataset.label}: $${ctx.parsed.y.toLocaleString('es-AR', {maximumFractionDigits:0})}`
          }
        }
      },
      scales: {
        x: { ...JSON.parse(JSON.stringify(chartDefaults.scales.x)) },
        y: {
          ...JSON.parse(JSON.stringify(chartDefaults.scales.y)),
          ticks: {
            color: '#6b7394',
            font: { family: 'DM Mono', size: 10 },
            callback: v => '$' + (v/1000).toFixed(0) + 'k'
          }
        }
      }
    }
  });
  buildGdpStats();
}

function buildGdpStats() {
  const el = document.getElementById('gdp-stats');
  el.innerHTML = countries.map(c => {
    const vals = gdpData[c];
    const last = vals[vals.length-1];
    const prev = vals[vals.length-2];
    const ch = ((last-prev)/prev*100).toFixed(1);
    const chClass = ch >= 0 ? 'pos' : 'neg';
    const chSign = ch >= 0 ? '+' : '';
    return `<div class="stat-card" style="border-top-color:${COLORS[c].line}">
      <div class="stat-label">${COLORS[c].label}</div>
      <div class="stat-value" style="color:${COLORS[c].line}">$${(last/1000).toFixed(1)}k</div>
      <div class="stat-change"><span class="${chClass}">${chSign}${ch}%</span> vs 2022</div>
    </div>`;
  }).join('');
}

function updateGdpRange() {
  gdpFrom = parseInt(document.getElementById('gdp-from').value);
  gdpTo = parseInt(document.getElementById('gdp-to').value);
  if (gdpFrom >= gdpTo) { gdpTo = gdpFrom + 1; document.getElementById('gdp-to').value = gdpTo; }
  document.getElementById('gdp-from-val').textContent = gdpFrom;
  document.getElementById('gdp-to-val').textContent = gdpTo;
  const { labels, datasets } = makeGdpDatasets(gdpFrom, gdpTo);
  gdpChart.data.labels = labels;
  gdpChart.data.datasets.forEach((ds, i) => { ds.data = datasets[i].data; });
  gdpChart.update();
}

// ─── EXPENDITURE CHART ────────────────────────────────────────────────────
function makeExpDatasets(from, to) {
  const idxFrom = expData.years.indexOf(from);
  const idxTo = expData.years.indexOf(to);
  const labels = expData.years.slice(idxFrom, idxTo+1);
  const datasets = countries.map(c => ({
    label: COLORS[c].label,
    data: expData[c].slice(idxFrom, idxTo+1),
    borderColor: COLORS[c].line,
    backgroundColor: COLORS[c].bg,
    borderWidth: 2,
    pointRadius: 0,
    pointHoverRadius: 5,
    tension: 0.35,
    fill: false,
    hidden: !activeCountries.has(c),
    borderDash: from <= 2023 && to > 2023 ? [] : [],
  }));
  // Mark projected years with dashed line
  datasets.forEach((ds, i) => {
    const c = countries[i];
    const allYears = expData.years.slice(idxFrom, idxTo+1);
    const projStart = allYears.indexOf(2024);
    if (projStart > -1) {
      ds.segment = {
        borderDash: ctx => ctx.p0DataIndex >= projStart - 1 ? [5, 4] : []
      };
    }
  });
  return { labels, datasets };
}

function buildExpChart() {
  const ctx = document.getElementById('expChart').getContext('2d');
  const { labels, datasets } = makeExpDatasets(expFrom, expTo);
  expChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      ...JSON.parse(JSON.stringify(chartDefaults)),
      plugins: {
        ...JSON.parse(JSON.stringify(chartDefaults.plugins)),
        tooltip: {
          ...JSON.parse(JSON.stringify(chartDefaults.plugins.tooltip)),
          callbacks: {
            label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}% del PBI`
          }
        }
      },
      scales: {
        x: { ...JSON.parse(JSON.stringify(chartDefaults.scales.x)) },
        y: {
          ...JSON.parse(JSON.stringify(chartDefaults.scales.y)),
          ticks: {
            color: '#6b7394',
            font: { family: 'DM Mono', size: 10 },
            callback: v => v + '%'
          }
        }
      }
    }
  });
  buildExpStats();
}

function buildExpStats() {
  const el = document.getElementById('exp-stats');
  el.innerHTML = countries.map(c => {
    const vals = expData[c];
    const last = vals[expData.years.indexOf(2023)];
    const prev = vals[expData.years.indexOf(2022)];
    const ch = (last-prev).toFixed(1);
    const chClass = ch >= 0 ? 'pos' : 'neg';
    const chSign = ch >= 0 ? '+' : '';
    return `<div class="stat-card" style="border-top-color:${COLORS[c].line}">
      <div class="stat-label">${COLORS[c].label}</div>
      <div class="stat-value" style="color:${COLORS[c].line}">${last}%</div>
      <div class="stat-change"><span class="${chClass}">${chSign}${ch} pp</span> vs 2022</div>
    </div>`;
  }).join('');
}

function updateExpRange() {
  expFrom = parseInt(document.getElementById('exp-from').value);
  expTo = parseInt(document.getElementById('exp-to').value);
  if (expFrom >= expTo) { expTo = expFrom + 1; document.getElementById('exp-to').value = expTo; }
  document.getElementById('exp-from-val').textContent = expFrom;
  document.getElementById('exp-to-val').textContent = expTo;
  const { labels, datasets } = makeExpDatasets(expFrom, expTo);
  expChart.data.labels = labels;
  expChart.data.datasets.forEach((ds, i) => {
    ds.data = datasets[i].data;
    ds.segment = datasets[i].segment;
  });
  expChart.update();
}

// ─── SCATTER CHART ────────────────────────────────────────────────────────
function getScatterPoint(c, yr) {
  const gdpIdx = gdpData.years.indexOf(yr);
  const expIdx = expData.years.indexOf(yr);
  if (gdpIdx === -1 || expIdx === -1) return null;
  return { x: expData[c][expIdx], y: gdpData[c][gdpIdx] };
}

function buildScatterChart() {
  const ctx = document.getElementById('scatterChart').getContext('2d');
  const datasets = countries.map(c => {
    const pt = getScatterPoint(c, scatterYear);
    return {
      label: COLORS[c].label,
      data: pt ? [pt] : [],
      backgroundColor: COLORS[c].line + 'cc',
      borderColor: COLORS[c].line,
      borderWidth: 2,
      pointRadius: 18,
      pointHoverRadius: 22,
      hidden: !activeCountries.has(c),
    };
  });

  scatterChart = new Chart(ctx, {
    type: 'scatter',
    data: { datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#ffffff',
          borderColor: '#dde1ee',
          borderWidth: 1,
          titleColor: '#1a1f36', bodyColor: '#1a1f36', titleFont: { family: 'DM Mono', size: 11 },
          bodyFont: { family: 'DM Mono', size: 11 },
          padding: 12,
          callbacks: {
            label: ctx => [`${ctx.dataset.label}`, `Gasto: ${ctx.parsed.x.toFixed(1)}% PIB`, `PIB pc: $${ctx.parsed.y.toLocaleString('es-AR', {maximumFractionDigits:0})}`]
          }
        }
      },
      scales: {
        x: {
          title: { display: true, text: 'Gasto Público (% del PBI)', color: '#6b7394', font: { family: 'DM Mono', size: 10 } },
          grid: { color: 'rgba(0,0,0,0.06)' },
          ticks: { color: '#6b7394', font: { family: 'DM Mono', size: 10 }, callback: v => v+'%' },
          border: { color: '#dde1ee' },
          min: 10, max: 55
        },
        y: {
          title: { display: true, text: 'PBI per cápita PPP (USD 2021)', color: '#6b7394', font: { family: 'DM Mono', size: 10 } },
          grid: { color: 'rgba(0,0,0,0.06)' },
          ticks: { color: '#6b7394', font: { family: 'DM Mono', size: 10 }, callback: v => '$'+(v/1000).toFixed(0)+'k' },
          border: { color: '#dde1ee' },
          min: 3000, max: 30000
        }
      }
    },
    plugins: [{
      id: 'labels',
      afterDraw(chart) {
        const { ctx } = chart;
        chart.data.datasets.forEach((ds, i) => {
          if (ds.hidden || ds.data.length === 0) return;
          const meta = chart.getDatasetMeta(i);
          if (!meta.visible) return;
          const pt = meta.data[0];
          ctx.save();
          ctx.fillStyle = '#1a1f36';
          ctx.font = '500 11px DM Mono, monospace';
          ctx.textAlign = 'center';
          ctx.fillText(countries[i], pt.x, pt.y - 22);
          ctx.restore();
        });
      }
    }]
  });
}

function updateScatter() {
  scatterYear = parseInt(document.getElementById('scatter-year').value);
  document.getElementById('scatter-year-val').textContent = scatterYear;
  countries.forEach((c, i) => {
    const pt = getScatterPoint(c, scatterYear);
    scatterChart.data.datasets[i].data = pt ? [pt] : [];
  });
  scatterChart.update();
}

function toggleAnimation() {
  const btn = document.getElementById('anim-btn');
  if (animInterval) {
    clearInterval(animInterval);
    animInterval = null;
    btn.textContent = '▶ PLAY';
  } else {
    btn.textContent = '⏹ STOP';
    let yr = 1995;
    animInterval = setInterval(() => {
      document.getElementById('scatter-year').value = yr;
      scatterYear = yr;
      document.getElementById('scatter-year-val').textContent = yr;
      updateScatter();
      yr++;
      if (yr > 2023) {
        clearInterval(animInterval);
        animInterval = null;
        btn.textContent = '▶ PLAY';
      }
    }, 200);
  }
}

// ─── INVESTMENT CHART ────────────────────────────────────────────────────
let invChart;
let invFrom = 1990, invTo = 2023;

function makeInvDatasets(from, to) {
  const idxFrom = invData.years.indexOf(from);
  const idxTo   = invData.years.indexOf(to);
  const labels  = invData.years.slice(idxFrom, idxTo + 1);
  const datasets = countries.map(c => ({
    label: COLORS[c].label,
    data: invData[c].slice(idxFrom, idxTo + 1),
    borderColor: COLORS[c].line,
    backgroundColor: COLORS[c].bg,
    borderWidth: 2,
    pointRadius: 0,
    pointHoverRadius: 5,
    tension: 0.35,
    fill: false,
    hidden: !activeCountries.has(c),
  }));
  return { labels, datasets };
}

function buildInvChart() {
  const ctx = document.getElementById('invChart').getContext('2d');
  const { labels, datasets } = makeInvDatasets(invFrom, invTo);
  invChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      ...JSON.parse(JSON.stringify(chartDefaults)),
      plugins: {
        ...JSON.parse(JSON.stringify(chartDefaults.plugins)),
        tooltip: {
          ...JSON.parse(JSON.stringify(chartDefaults.plugins.tooltip)),
          callbacks: {
            label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}% del PBI`
          }
        }
      },
      scales: {
        x: { ...JSON.parse(JSON.stringify(chartDefaults.scales.x)) },
        y: {
          ...JSON.parse(JSON.stringify(chartDefaults.scales.y)),
          ticks: {
            color: '#6b7394',
            font: { family: 'DM Mono', size: 10 },
            callback: v => v + '%'
          }
        }
      }
    }
  });
  buildInvStats();
}

function buildInvStats() {
  const el = document.getElementById('inv-stats');
  el.innerHTML = countries.map(c => {
    const lastIdx = invData.years.indexOf(2023);
    const prevIdx = invData.years.indexOf(2022);
    const last = invData[c][lastIdx];
    const prev = invData[c][prevIdx];
    const ch = (last - prev).toFixed(1);
    const chClass = ch >= 0 ? 'pos' : 'neg';
    const chSign  = ch >= 0 ? '+' : '';
    return `<div class="stat-card" style="border-top-color:${COLORS[c].line}">
      <div class="stat-label">${COLORS[c].label}</div>
      <div class="stat-value" style="color:${COLORS[c].line}">${last}%</div>
      <div class="stat-change"><span class="${chClass}">${chSign}${ch} pp</span> vs 2022</div>
    </div>`;
  }).join('');
}

function updateInvRange() {
  invFrom = parseInt(document.getElementById('inv-from').value);
  invTo   = parseInt(document.getElementById('inv-to').value);
  if (invFrom >= invTo) { invTo = invFrom + 1; document.getElementById('inv-to').value = invTo; }
  document.getElementById('inv-from-val').textContent = invFrom;
  document.getElementById('inv-to-val').textContent   = invTo;
  const { labels, datasets } = makeInvDatasets(invFrom, invTo);
  invChart.data.labels = labels;
  invChart.data.datasets.forEach((ds, i) => { ds.data = datasets[i].data; });
  invChart.update();
}

// ─── TABS ────────────────────────────────────────────────────────────────
function switchTab(name, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  btn.classList.add('active');
}

// ─── COUNTRY TOGGLE ──────────────────────────────────────────────────────
function toggleCountry(c, el) {
  if (activeCountries.has(c)) {
    activeCountries.delete(c);
    el.classList.add('inactive');
  } else {
    activeCountries.add(c);
    el.classList.remove('inactive');
  }
  // Update all charts
  const cIdx = countries.indexOf(c);
  if (gdpChart) {
    gdpChart.data.datasets[cIdx].hidden = !activeCountries.has(c);
    gdpChart.update();
  }
  if (expChart) {
    expChart.data.datasets[cIdx].hidden = !activeCountries.has(c);
    expChart.update();
  }
  if (invChart) {
    invChart.data.datasets[cIdx].hidden = !activeCountries.has(c);
    invChart.update();
  }
  if (scatterChart) {
    scatterChart.data.datasets[cIdx].hidden = !activeCountries.has(c);
    scatterChart.update();
  }
}

// ─── INIT ────────────────────────────────────────────────────────────────
window.addEventListener('DOMContentLoaded', () => {
  buildGdpChart();
  buildExpChart();
  buildInvChart();
  buildScatterChart();
});
</script>
</body>
</html>
